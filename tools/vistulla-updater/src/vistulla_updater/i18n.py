from __future__ import annotations

import os
from typing import Dict


_TRANSLATIONS: Dict[str, Dict[str, str]] = {
    "pl": {
        "app.title": "VistulaOS Updater",
        "tab.system": "System",
        "tab.flatpak": "Flatpak",
        "tab.settings": "Ustawienia",
        "sys.check": "Sprawdź aktualizacje",
        "sys.update": "Aktualizuj system",
        "sys.col.pkg": "Pakiet",
        "sys.col.cur": "Obecna",
        "sys.col.new": "Nowa",
        "sys.status.checking": "Sprawdzanie aktualizacji…",
        "sys.status.check_error": "Błąd podczas sprawdzania aktualizacji.",
        "sys.status.found": "Znaleziono aktualizacje: {n}",
        "sys.status.updating": "Aktualizacja systemu… (wymaga autoryzacji)",
        "sys.status.no_pacman": "Wymagany pakiet: pacman",
        "sys.status.updated": "System zaktualizowany.",
        "sys.status.update_failed": "Aktualizacja systemu nie powiodła się.",
        "sys.log.update_header": "--- Aktualizacja systemu (pacman) ---",
        "sys.err.no_pacman": "Błąd: brak pacman w systemie.",
        "fp.subtab.store": "Sklep",
            "fp.store.remote": "Remote sklepu",
            "fp.store.refresh": "Odśwież listę",
            "fp.store.categories": "Kategorie",
            "fp.store.category.all": "Wszystkie",
            "fp.store.filter": "Filtr",
        "fp.subtab.installed": "Zainstalowane",
        "fp.subtab.remotes": "Remotes",
        "fp.search.placeholder": "Szukaj aplikacji (np. firefox)",
        "fp.search": "Szukaj",
        "fp.install": "Instaluj zaznaczoną",
        "fp.uninstall": "Odinstaluj zaznaczoną",
            "fp.details.title": "Szczegóły aplikacji",
            "fp.details.appid": "AppID",
            "fp.details.name": "Nazwa",
            "fp.details.origin": "Origin",
            "fp.details.version": "Wersja",
            "fp.details.branch": "Gałąź",
            "fp.details.license": "Licencja",
            "fp.details.author": "Autor",
            "fp.details.size": "Rozmiar",
            "fp.details.description": "Opis",
            "fp.details.loading": "Ładowanie szczegółów…",
            "fp.details.load_failed": "Nie udało się pobrać szczegółów.",
        "fp.update_all": "Aktualizuj Flatpaki",
        "fp.refresh_installed": "Odśwież zainstalowane",
        "fp.refresh_remotes": "Odśwież remotes",
        "fp.add_remote": "Dodaj remote",
        "fp.remote.apps": "Aplikacje z tego remote",
        "fp.remote.uninstall_app": "Odinstaluj zaznaczoną aplikację",
        "fp.set_default_remote": "Ustaw domyślny",
        "fp.col.appid": "AppID",
        "fp.col.name": "Nazwa",
        "fp.col.origin": "Origin",
        "fp.col.remote": "Nazwa",
        "fp.col.url": "URL",
        "fp.col.default": "Domyślny",
        "fp.status.no_flatpak": "Wymagany pakiet: flatpak",
        "fp.status.no_selection": "Zaznacz pozycję z listy.",
        "fp.status.type_query": "Wpisz frazę do wyszukania.",
        "fp.status.searching": "Wyszukiwanie…",
        "fp.status.search_error": "Błąd wyszukiwania.",
        "fp.status.results": "Wyniki: {n}",
        "fp.status.installing": "Instalacja…",
        "fp.status.installed": "Zainstalowano.",
        "fp.status.install_failed": "Instalacja nie powiodła się.",
        "fp.status.uninstalling": "Odinstalowywanie…",
        "fp.status.uninstalled": "Odinstalowano.",
        "fp.status.uninstall_failed": "Odinstalowanie nie powiodło się.",
        "fp.status.updating": "Aktualizacja Flatpak…",
        "fp.status.updated": "Flatpaki zaktualizowane.",
        "fp.status.update_failed": "Aktualizacja Flatpak nie powiodła się.",
        "fp.status.loading_installed": "Wczytywanie zainstalowanych…",
        "fp.status.loading_remotes": "Wczytywanie remotes…",
        "fp.status.loading_store": "Wczytywanie sklepu…",
        "fp.status.no_remote": "Brak remote do sklepu.",
        "fp.status.remote_added": "Remote dodany.",
        "fp.status.remote_add_failed": "Nie udało się dodać remote.",
        "fp.status.remote_apps_loading": "Wczytywanie aplikacji z remote…",
        "fp.status.remote_default_set": "Ustawiono domyślny remote.",
        "fp.status.remote_default_failed": "Nie udało się ustawić domyślnego remote.",
        "settings.language": "Język",
        "settings.theme": "Motyw",
        "settings.theme.auto": "Automatycznie z Cinnamon",
        "dialog.add_remote.title": "Dodaj remote Flatpak",
        "dialog.add_remote.name": "Nazwa",
        "dialog.add_remote.url": "URL repo",
        "dialog.add_remote.make_default": "Ustaw jako domyślny",
        "dialog.cancel": "Anuluj",
        "dialog.add": "Dodaj",
    },
    "en": {
        "app.title": "VistulaOS Updater",
        "tab.system": "System",
        "tab.flatpak": "Flatpak",
        "tab.settings": "Settings",
        "sys.check": "Check updates",
        "sys.update": "Update system",
        "sys.col.pkg": "Package",
        "sys.col.cur": "Current",
        "sys.col.new": "New",
        "sys.status.checking": "Checking updates…",
        "sys.status.check_error": "Failed to check updates.",
        "sys.status.found": "Updates found: {n}",
        "sys.status.updating": "Updating system… (authorization required)",
        "sys.status.no_pacman": "Required package: pacman",
        "sys.status.updated": "System updated.",
        "sys.status.update_failed": "System update failed.",
        "sys.log.update_header": "--- System update (pacman) ---",
        "sys.err.no_pacman": "Error: pacman not found.",
        "fp.subtab.store": "Store",
            "fp.store.remote": "Store remote",
            "fp.store.refresh": "Refresh list",
            "fp.store.categories": "Categories",
            "fp.store.category.all": "All",
            "fp.store.filter": "Filter",
        "fp.subtab.installed": "Installed",
        "fp.subtab.remotes": "Remotes",
        "fp.search.placeholder": "Search apps (e.g. firefox)",
        "fp.search": "Search",
        "fp.install": "Install selected",
        "fp.uninstall": "Uninstall selected",
            "fp.details.title": "App details",
            "fp.details.appid": "AppID",
            "fp.details.name": "Name",
            "fp.details.origin": "Origin",
            "fp.details.version": "Version",
            "fp.details.branch": "Branch",
            "fp.details.license": "License",
            "fp.details.author": "Author",
            "fp.details.size": "Size",
            "fp.details.description": "Description",
            "fp.details.loading": "Loading details…",
            "fp.details.load_failed": "Failed to load details.",
        "fp.update_all": "Update Flatpaks",
        "fp.refresh_installed": "Refresh installed",
        "fp.refresh_remotes": "Refresh remotes",
        "fp.add_remote": "Add remote",
        "fp.remote.apps": "Apps from this remote",
        "fp.remote.uninstall_app": "Uninstall selected app",
        "fp.set_default_remote": "Set default",
        "fp.col.appid": "AppID",
        "fp.col.name": "Name",
        "fp.col.origin": "Origin",
        "fp.col.remote": "Name",
        "fp.col.url": "URL",
        "fp.col.default": "Default",
        "fp.status.no_flatpak": "Required package: flatpak",
        "fp.status.no_selection": "Select an item in the list.",
        "fp.status.type_query": "Type a search query.",
        "fp.status.searching": "Searching…",
        "fp.status.search_error": "Search failed.",
        "fp.status.results": "Results: {n}",
        "fp.status.installing": "Installing…",
        "fp.status.installed": "Installed.",
        "fp.status.install_failed": "Install failed.",
        "fp.status.uninstalling": "Uninstalling…",
        "fp.status.uninstalled": "Uninstalled.",
        "fp.status.uninstall_failed": "Uninstall failed.",
        "fp.status.updating": "Updating Flatpak…",
        "fp.status.updated": "Flatpaks updated.",
        "fp.status.update_failed": "Flatpak update failed.",
        "fp.status.loading_installed": "Loading installed…",
        "fp.status.loading_remotes": "Loading remotes…",
        "fp.status.loading_store": "Loading store…",
        "fp.status.no_remote": "No store remote.",
        "fp.status.remote_added": "Remote added.",
        "fp.status.remote_add_failed": "Failed to add remote.",
        "fp.status.remote_apps_loading": "Loading remote apps…",
        "fp.status.remote_default_set": "Default remote set.",
        "fp.status.remote_default_failed": "Failed to set default remote.",
        "settings.language": "Language",
        "settings.theme": "Theme",
        "settings.theme.auto": "Automatic from Cinnamon",
        "dialog.add_remote.title": "Add Flatpak remote",
        "dialog.add_remote.name": "Name",
        "dialog.add_remote.url": "Repo URL",
        "dialog.add_remote.make_default": "Set as default",
        "dialog.cancel": "Cancel",
        "dialog.add": "Add",
    },
}


_language: str = "pl"


def detect_language() -> str:
    lang = os.environ.get("LANG", "").lower()
    if lang.startswith("en"):
        return "en"
    return "pl"


def set_language(lang: str) -> None:
    global _language
    if lang not in _TRANSLATIONS:
        lang = "pl"
    _language = lang


def t(key: str, **kwargs) -> str:
    table = _TRANSLATIONS.get(_language) or _TRANSLATIONS["pl"]
    text = table.get(key) or _TRANSLATIONS["pl"].get(key) or key
    if kwargs:
        try:
            return text.format(**kwargs)
        except Exception:
            return text
    return text
